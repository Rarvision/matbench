name: env-setup-and-docker-create

on:
  workflow_dispatch:
    inputs:
      model:
        description: "The model name"
        required: true
        type: string
      python_version:
        description: "Python version to use"
        required: true
        type: string
      system_dependencies:
        description: "Additional system dependencies to install"
        required: false
        default: "git"
        type: string
      conda_env_file:
        description: "Optional Conda environment YAML file"
        required: false
        type: string
      pip_requirements_file:
        description: "Optional pip requirements.txt file"
        required: false
        type: string
      custom_pip_lines:
        description: "Optional custom pip install lines"
        required: false
        type: string

jobs:
  build-env:
    runs-on: ubuntu-latest

    steps:
      - name: Install system dependencies
        run: |
          if [ ! -z "${{ inputs.system_dependencies }}" ]; then
            sudo apt-get update
            sudo apt-get install -y ${{ inputs.system_dependencies }}
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: ${{ inputs.python_version }}

      - name: Set up Conda environment
        run: |
          set -Eeuo pipefail
          eval "$(conda shell.bash hook)"
          cd benchmarks/matbench_v0.1_${{ inputs.model }}

          if [ ! -z "${{ inputs.conda_env_file }}" ] && [ -f "${{ inputs.conda_env_file }}" ]; then
            echo "Creating env from YAML: ${{ inputs.conda_env_file }}"
            conda env create --name ${{ inputs.model }} --file ${{ inputs.conda_env_file }}
            exit 0
          fi

          conda create -y --name ${{ inputs.model }} python=${{ inputs.python_version }}
          conda activate ${{ inputs.model }}

          if [ ! -z "${{ inputs.pip_requirements_file }}" ] && [ -f "${{ inputs.pip_requirements_file }}" ]; then
            echo "Installing pip deps from: ${{ inputs.pip_requirements_file }}"
            pip install -r ${{ inputs.pip_requirements_file }}
            exit 0
          elif [ ! -z "${{ inputs.custom_pip_lines }}" ]; then
            echo "Installing custom pip deps: ${{ inputs.custom_pip_lines }}"
            eval "${{ inputs.custom_pip_lines }}"
            exit 0
          else
            PACKAGES=$(python -c "import json;d=json.load(open('info.json'));f=lambda x:[x] if isinstance(x,str) else [y for i in x for y in f(i)] if isinstance(x,(list,tuple)) else [y for v in x.values() for y in f(v)] if isinstance(x,dict) else [];seen=set();out=[];[out.append(s) or seen.add(s) for s in (t.strip() for t in f(d.get('requirements',{}).get('python',[]))) if s and s not in seen];print(' '.join(out))")
            echo "PACKAGES: $PACKAGES"
            PACKAGES_CONDA=${PACKAGES//==/=}
            pip install $PACKAGES || conda install $PACKAGES_CONDA -c conda-forge -c pytorch -c pyg -y
          fi

      - name: Install matbench
        run: |
          set -Eeuo pipefail
          eval "$(conda shell.bash hook)"
          cd benchmarks/matbench_v0.1_${{ inputs.model }}

          conda activate ${{ inputs.model }}
          if python -c "import importlib.util,sys; sys.exit(0 if importlib.util.find_spec('matbench') else 1)"; then
            echo "matbench already installed"
            exit 0
          else
            pip install matbench
          fi

      - name: Run import test, export env and pack env
        shell: bash -l {0}
        run: |
          set -Eeuo pipefail
          eval "$(conda shell.bash hook)"
          cd benchmarks/matbench_v0.1_${{ inputs.model }}

          conda activate "${{ inputs.model }}"

          if ! python -c "import nbconvert, jupyter_core" >/dev/null 2>&1; then
            conda install -y nbconvert jupyter-core || python -m pip install -U nbconvert jupyter
          fi

          shopt -s nullglob
          for nb in *.ipynb; do
            python -m jupyter nbconvert --to script "$nb"
          done

          python -c "import ast,pathlib; m=set(); [m.add(a.name.split('.')[0]) for p in pathlib.Path('.').glob('*.py') if p.name!='imports_only.py' for node in ast.walk(ast.parse(p.read_text(encoding='utf-8',errors='ignore'),filename=str(p))) if isinstance(node,ast.Import) for a in node.names]; [m.add(node.module.split('.')[0]) for p in pathlib.Path('.').glob('*.py') if p.name!='imports_only.py' for node in ast.walk(ast.parse(p.read_text(encoding='utf-8',errors='ignore'),filename=str(p))) if isinstance(node,ast.ImportFrom) and node.level==0 and node.module]; open('imports_only.py','w',encoding='utf-8').write(''.join(f'import {x}\n' for x in sorted(filter(None,m))))"
          python imports_only.py

          OUT="${{ inputs.model }}-${{ inputs.python_version }}.yml"
          conda env export -n "${{ inputs.model }}" --no-builds | sed '/^prefix: /d' > "$OUT"
          echo "Exported env: $OUT"
          ls -lh "$OUT"

          pip install conda-pack
          PACKED="${{ inputs.model }}-env.tar.gz"
          conda-pack -n "${{ inputs.model }}" -o "$PACKED"
          echo "Packed env: $PACKED"
          ls -lh "$PACKED"

      - name: Upload env artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.model }}-${{ inputs.python_version }}-env
          path: |
            benchmarks/matbench_v0.1_${{ inputs.model }}/${{ inputs.model }}-${{ inputs.python_version }}.yml
            benchmarks/matbench_v0.1_${{ inputs.model }}/${{ inputs.model }}-env.tar.gz
          if-no-files-found: error

  build-docker:
    runs-on: ubuntu-latest
    needs: build-env
  
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Download env artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.model }}-${{ inputs.python_version }}-env
          path: .
  
      - name: Prepare Docker context
        run: |
          set -Eeuo pipefail
  
          # 切换到 model 对应的目录
          cd benchmarks/matbench_v0.1_${{ inputs.model }}
  
          # 确保 env.tar.gz 文件存在
          if [ ! -f "${{ inputs.model }}-env.tar.gz" ]; then
            echo "❌ ERROR: env.tar.gz not found:"
            echo "Expected: benchmarks/matbench_v0.1_${{ inputs.model }}/${{ inputs.model }}-env.tar.gz"
            echo "Files in this directory:"
            ls -lh .
            exit 1
          fi
  
          cp "${{ inputs.model }}-env.tar.gz" env.tar.gz
  
          cat > Dockerfile << 'EOF'
          FROM continuumio/miniconda3
          WORKDIR /workspace
          COPY env.tar.gz /tmp/env.tar.gz
          COPY . /workspace
          RUN mkdir -p /opt/conda/envs/${MODEL_NAME} \
              && tar -xzf /tmp/env.tar.gz -C /opt/conda/envs/${MODEL_NAME} \
              && /opt/conda/envs/${MODEL_NAME}/bin/conda-unpack \
              && rm /tmp/env.tar.gz
          ENV PATH=/opt/conda/envs/${MODEL_NAME}/bin:$PATH
          CMD ["bash"]
          EOF
  
          sed -i "s/\${MODEL_NAME}/${{ inputs.model }}/g" Dockerfile
  
      - name: Build Docker image
        run: |
          set -Eeuo pipefail
          cd benchmarks/matbench_v0.1_${{ inputs.model }}
          IMAGE_TAG=$(echo "${{ inputs.model }}-py${{ inputs.python_version }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          docker build -t "$IMAGE_TAG" .
  
      - name: Save Docker image to tar
        run: |
          set -Eeuo pipefail
          cd benchmarks/matbench_v0.1_${{ inputs.model }}
          IMAGE_TAG=${IMAGE_TAG:-$(echo "${{ inputs.model }}-py${{ inputs.python_version }}" | tr '[:upper:]' '[:lower:]')}
          OUT="${IMAGE_TAG}.tar"
          docker save "$IMAGE_TAG" -o "$OUT"
          ls -lh "$OUT"
  
      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ inputs.model }}-py${{ inputs.python_version }}
          path: benchmarks/matbench_v0.1_${{ inputs.model }}/$(echo "${{ inputs.model }}-py${{ inputs.python_version }}" | tr '[:upper:]' '[:lower:]').tar
          if-no-files-found: error
